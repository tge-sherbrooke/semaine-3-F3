name: Formatif F3 - Progressive Milestones
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  autograding:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install pytest
        run: pip install -q pytest

      # =========================================
      # MILESTONE 1: Environment Setup (25 points)
      # =========================================
      - name: "Milestone 1: Environment Setup (25 pts)"
        id: milestone-1
        continue-on-error: true
        run: |
          echo "=============================================="
          echo "MILESTONE 1: Environment Setup"
          echo "=============================================="
          echo ""
          echo "Verifying: script exists, syntax valid, local tests executed"
          echo ""
          pytest tests/test_milestone_01.py -v --tb=short
          echo "milestone_1_passed=true" >> $GITHUB_OUTPUT

      # =========================================
      # MILESTONE 2: I2C Sensor Reading (35 points)
      # =========================================
      - name: "Milestone 2: I2C Sensor Reading (35 pts)"
        id: milestone-2
        continue-on-error: true
        run: |
          echo "=============================================="
          echo "MILESTONE 2: I2C Sensor Reading"
          echo "=============================================="
          echo ""
          echo "Verifying: I2C init, AHT20 sensor creation, temperature/humidity reading"
          echo ""
          pytest tests/test_milestone_02.py -v --tb=short
          echo "milestone_2_passed=true" >> $GITHUB_OUTPUT

      # =========================================
      # MILESTONE 3: Retry Logic + Quality (40 points)
      # =========================================
      - name: "Milestone 3: Retry Logic + Quality (40 pts)"
        id: milestone-3
        run: |
          echo "=============================================="
          echo "MILESTONE 3: Retry Logic + Quality"
          echo "=============================================="
          echo ""
          echo "Verifying: retry logic, error handling, code quality"
          echo ""
          pytest tests/test_milestone_03.py -v --tb=short

      # =========================================
      # MILESTONE 4: Multi-Sensor Integration (25 points)
      # =========================================
      - name: "Milestone 4: Multi-Sensor Integration (25 pts)"
        id: milestone-4
        continue-on-error: true
        run: |
          echo "=============================================="
          echo "MILESTONE 4: Multi-Sensor Integration"
          echo "=============================================="
          echo ""
          echo "Verifying: VCNL4200 import, sensor creation, proximity/lux reading"
          echo ""
          pytest tests/test_milestone_04.py -v --tb=short
          echo "milestone_4_passed=true" >> $GITHUB_OUTPUT

      # =========================================
      # Summary
      # =========================================
      - name: Results Summary
        if: always()
        run: |
          echo ""
          echo "=============================================="
          echo "         FORMATIF F3 - RESULTS SUMMARY       "
          echo "=============================================="
          echo ""
          echo "  Milestone 1 (25 pts): ${{ steps.milestone-1.outcome }}"
          echo "  Milestone 2 (35 pts): ${{ steps.milestone-2.outcome }}"
          echo "  Milestone 3 (40 pts): ${{ steps.milestone-3.outcome }}"
          echo "  Milestone 4 (25 pts): ${{ steps.milestone-4.outcome }}"
          echo ""
          echo "=============================================="
          echo ""
          echo "  Retries illimites!"
          echo "  Poussez a nouveau pour reessayer."
          echo ""
          echo "  Les messages d'erreur indiquent:"
          echo "    - Ce qui etait attendu"
          echo "    - Ce qui a ete trouve"
          echo "    - Une suggestion pour corriger"
          echo ""
          echo "=============================================="

      - name: Generate Step Summary
        if: always()
        run: |
          echo "## Formatif F3 - Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Milestone | Points | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1. Environment Setup | 25 | ${{ steps.milestone-1.outcome == 'success' && 'PASS' || 'FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 2. I2C Sensor Reading | 35 | ${{ steps.milestone-2.outcome == 'success' && 'PASS' || 'FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 3. Retry Logic + Quality | 40 | ${{ steps.milestone-3.outcome == 'success' && 'PASS' || 'FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 4. Multi-Sensor (VCNL4200) | 25 | ${{ steps.milestone-4.outcome == 'success' && 'PASS' || 'FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Retries illimites** - Poussez a nouveau pour reessayer!" >> $GITHUB_STEP_SUMMARY
